// src/app/api/artifacts/stakeholder-register/export/pdf/route.ts
import "server-only";

import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@/utils/supabase/server";

export const runtime = "nodejs";
export const maxDuration = 60;

/* ──────────────────────────────────────────────── Helpers ──────────────────────────────────────────────── */
function jsonErr(message: string, status = 400, details?: Record<string, unknown>) {
  return NextResponse.json({ ok: false, error: message, details }, { status });
}

function sanitizeFilename(input: string): string {
  return (
    String(input || "stakeholder-register")
      .replace(/[^a-z0-9._-]+/gi, "_")
      .replace(/_+/g, "_")
      .replace(/^_|_$/g, "")
      .slice(0, 120) || "stakeholder-register"
  );
}

function safeStr(x: any): string {
  return typeof x === "string" ? x : x == null ? "" : String(x);
}

function escapeHtml(str: any) {
  return String(str ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function normalizeChannelList(x: any): string {
  if (Array.isArray(x)) return x.map((v) => safeStr(v)).filter(Boolean).join(", ");
  return safeStr(x);
}

type StakeholderRowForExport = {
  id: string;
  name: string;
  role?: string | null;
  influence_level?: string | null;
  contact_info?: any | null;
};

export async function POST(req: NextRequest) {
  // ---------- PDF (Puppeteer) ----------
  let puppeteer: any;
  try {
    puppeteer = await import("puppeteer");
  } catch {
    return NextResponse.json(
      { ok: false, error: `Missing dependency "puppeteer". Install it to enable PDF export.` },
      { status: 501 }
    );
  }

  try {
    const body = await req.json().catch(() => ({}));
    const projectId = String(body?.projectId || "").trim();
    const artifactId = String(body?.artifactId || "").trim();
    if (!projectId) return jsonErr("Missing projectId", 400);
    if (!artifactId) return jsonErr("Missing artifactId", 400);

    const supabase = await createClient();

    const { data: project } = await supabase
      .from("projects")
      .select("id,name,human_id")
      .eq("id", projectId)
      .single();

    const { data: artifact } = await supabase
      .from("artifacts")
      .select("id,title")
      .eq("id", artifactId)
      .single();

    const { data: stakeholders, error } = await supabase
      .from("stakeholders")
      .select("id,name,role,influence_level,contact_info")
      .eq("project_id", projectId)
      .eq("artifact_id", artifactId)
      .order("created_at", { ascending: true });

    if (error) return jsonErr(error.message || "Failed to load stakeholders", 500);

    const rows = (Array.isArray(stakeholders) ? stakeholders : []) as StakeholderRowForExport[];

    const title = "Stakeholder Register";
    const projectName = safeStr(project?.name);
    const projectHumanId = safeStr(project?.human_id);

    const tableRows = rows
      .map((r) => {
        const c = r?.contact_info && typeof r.contact_info === "object" ? r.contact_info : {};
        return `
          <tr>
            <td>${escapeHtml(r.name)}</td>
            <td>${escapeHtml(c?.point_of_contact)}</td>
            <td>${escapeHtml(r.role)}</td>
            <td>${escapeHtml(c?.internal_external)}</td>
            <td>${escapeHtml(c?.title_role)}</td>
            <td>${escapeHtml(c?.impact_level || "Medium")}</td>
            <td>${escapeHtml(r.influence_level)}</td>
            <td>${escapeHtml(c?.stakeholder_mapping)}</td>
            <td>${escapeHtml(c?.involvement_milestone)}</td>
            <td>${escapeHtml(c?.stakeholder_impact)}</td>
            <td>${escapeHtml(normalizeChannelList(c?.channels))}</td>
            <td>${escapeHtml(c?.group || "Project")}</td>
          </tr>
        `;
      })
      .join("");

    const base = sanitizeFilename(artifact?.title || project?.name || "Stakeholder_Register");

    const html = `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>${escapeHtml(title)}</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      color: #111827;
      margin: 0;
      padding: 0;
    }
    .wrap { padding: 24px; }
    h1 { margin: 0 0 6px 0; font-size: 18px; }
    .meta { color: #6b7280; font-size: 12px; margin-bottom: 14px; }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 10px;
    }
    thead th {
      text-align: left;
      padding: 8px 8px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-weight: 700;
    }
    tbody td {
      padding: 7px 8px;
      border: 1px solid #e5e7eb;
      vertical-align: top;
      word-break: break-word;
    }
    tbody tr:nth-child(even) td { background: #fafafa; }

    /* keep header row on each page */
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }

    .small { font-size: 9px; color: #6b7280; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>${escapeHtml(title)}</h1>
    <div class="meta">
      <div><strong>Project:</strong> ${escapeHtml(projectName)} ${
        projectHumanId ? `(${escapeHtml(projectHumanId)})` : ""
      }</div>
      <div class="small">Generated: ${escapeHtml(new Date().toISOString().replace("T", " ").slice(0, 19))} UTC</div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 10%">Name</th>
          <th style="width: 10%">Point of Contact</th>
          <th style="width: 7%">Role</th>
          <th style="width: 6%">Type</th>
          <th style="width: 8%">Title/Role</th>
          <th style="width: 6%">Impact</th>
          <th style="width: 7%">Influence</th>
          <th style="width: 8%">Mapping</th>
          <th style="width: 8%">Milestone</th>
          <th style="width: 12%">Impact Notes</th>
          <th style="width: 10%">Channels</th>
          <th style="width: 8%">Group</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows || `<tr><td colspan="12" style="padding: 14px; color:#6b7280;">No stakeholders found.</td></tr>`}
      </tbody>
    </table>
  </div>
</body>
</html>`;

    // Launch Puppeteer
    const browser = await puppeteer.launch({
      headless: "new",
      args: ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage", "--disable-gpu"],
    });

    try {
      const page = await browser.newPage();
      await page.setViewport({ width: 1240, height: 1754 }); // approx A4
      await page.setContent(html, { waitUntil: "networkidle0" });

      const pdf = await page.pdf({
        format: "A4",
        printBackground: true,
        margin: { top: "70px", right: "24px", bottom: "60px", left: "24px" },
        displayHeaderFooter: true,
        headerTemplate: `
          <div style="width:100%; font-size:10px; color:#6b7280; padding: 0 24px;">
            <span>${escapeHtml(title)} — ${escapeHtml(projectName)} ${
              projectHumanId ? `(${escapeHtml(projectHumanId)})` : ""
            }</span>
          </div>
        `,
        footerTemplate: `
          <div style="width:100%; font-size:10px; color:#6b7280; padding: 0 24px; display:flex; justify-content:space-between;">
            <span>Generated ${escapeHtml(new Date().toISOString().slice(0,10))}</span>
            <span>Page <span class="pageNumber"></span> of <span class="totalPages"></span></span>
          </div>
        `,
      });

      return new NextResponse(pdf, {
        status: 200,
        headers: {
          "Content-Type": "application/pdf",
          "Content-Disposition": `attachment; filename="${base}.pdf"`,
          "Cache-Control": "no-store",
        },
      });
    } finally {
      await browser.close();
    }
  } catch (e: any) {
    return jsonErr(e?.message || "Failed to export PDF", 500);
  }
}
